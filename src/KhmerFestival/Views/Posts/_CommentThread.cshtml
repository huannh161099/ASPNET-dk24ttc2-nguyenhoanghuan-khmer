@model KhmerFestival.Models.Comment
@using KhmerFestival.Models
@{
    var all = (IEnumerable<Comment>)(ViewData["AllComments"] ?? Enumerable.Empty<Comment>());
    var children = all.Where(c => c.ParentId == Model.Id).OrderBy(c => c.CreatedAt).ToList();

    string author = Model.User?.DisplayName ?? Model.User?.Email ?? "Người dùng";
    string myId = Context.User?.Claims?.FirstOrDefault(c => c.Type.Contains("nameidentifier"))?.Value ?? "";
    bool isOwner = myId == Model.UserId;
    bool isAdmin = Context.User.IsInRole("Admin");
}

<div id="cmt-@Model.Id" class="mt-3">
    <div class="d-flex">
        <div class="rounded-circle bg-secondary-subtle flex-shrink-0" style="width:38px;height:38px;"></div>
        <div class="ms-2 flex-grow-1">
            <div class="d-flex align-items-center gap-2">
                <span class="fw-semibold small">@author</span>
                <span class="text-muted small">• @Model.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
            </div>

            @if (Model.IsDeleted)
            {
                <div class="mt-1 fst-italic text-muted">Bình luận đã bị xoá.</div>
            }
            else
            {
                <div class="mt-1">@Model.Content</div>
            }

            <div class="mt-1 small">
                @if (!Model.IsDeleted && (User.Identity?.IsAuthenticated ?? false))
                {
                    <a href="#" class="link-primary me-2" onclick="toggleReply(@Model.Id);return false;">Trả lời</a>
                }
                @if (!Model.IsDeleted && (isOwner || isAdmin))
                {
                    <form asp-controller="Comments" asp-action="Delete" method="post" class="d-inline" onsubmit="return confirm('Xoá bình luận này?');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-link p-0 text-danger">Xoá</button>
                    </form>
                }
            </div>

            @if (!Model.IsDeleted && (User.Identity?.IsAuthenticated ?? false))
            {
                <form id="reply-form-@Model.Id" asp-controller="Comments" asp-action="Create" method="post" class="d-none mt-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="postId" value="@Model.PostId" />
                    <input type="hidden" name="parentId" value="@Model.Id" />
                    <textarea name="content" rows="2" class="form-control" placeholder="Nhập nội dung trả lời..."></textarea>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary" type="submit">Gửi trả lời</button>
                    </div>
                </form>
            }

            @if (children.Any())
            {
                <div class="mt-2 ps-3 border-start">
                    @foreach (var child in children)
                    {
                        
                        @await Html.PartialAsync("_CommentThread", child)
                    }
                </div>
            }
        </div>
    </div>
</div>
